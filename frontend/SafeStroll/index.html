<!DOCTYPE html>
<html lang="en">

    <head>
        <title>SafeStroll</title>
        <link rel="shortcut icon" type="image/png" href="./assets/favicon.png" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Predicts safe routes for pedestrians using machine learning and data-driven decision making.">
        <meta name="author" content="Michael Inouye's Gamer Squadron">

        <link rel="stylesheet" type="text/css" href="./css/bootstrap-3.3.7-dist/bootstrap.min.css">
        <link rel="stylesheet" href="./lib/leaflet/leaflet.css"/>
        <link rel="stylesheet" href="./lib/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.css" />
        <link rel="stylesheet" type="text/css" href="./css/geosearch.css">
        <link rel="stylesheet" type="text/css" href="./css/styles.css">

        <script src="./js/jquery-3.1.0.min.js" type="text/javascript"></script>
        <script src="./lib/leaflet/leaflet.js"></script>
        <script src="./js/bundle.min.js"></script>
        <script src="./lib/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.js"></script>
        <script src="./lib/leaflet-control-geocoder-1.6.0/dist/Control.GeoCoder.js"></script>
    </head>

    <body>

        <section>

            <div id="mapid"></div>
            <script>
            
                var mymap = L.map('mapid').setView([32.231553, -110.951820], 15);
            
                // Instantiate Leaflet Map
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                    id: 'mapbox.streets'
                }).addTo(mymap);
            
                </script>   
        </section>

        <section id="fields">
            <div class="container">
                <div class="row">
                    <div class="col-md-6" style="text-align: center">
                        <h1>StrollSafe</h1>
                        <p>Hack Arizona 2019 Submission, a webapp that predicts safe routes for pedestrians using machine learning and data-driven decision making.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="origination">Origination</label>
                            <input type="text" class="form-control" id="origination" aria-describedby="" placeholder="Enter current location">
                        </div>
                        <div class="form-group">
                            <label for="destination">Destination</label>
                            <input type="text" class="form-control" id="destination" placeholder="Enter destination">
                        </div>
                        <button type="submit" id="submit-button" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </section>


    </body>
    <script>
         $origination = $("#origination");
                $destination = $("#destination");
                $button = $("#submit-button");
                
                var route = L.Routing.control({
                                waypoints: [
                                ]
                            }).addTo(mymap);

                var latLngOrigin;
                var markerOrigin;

                $button.click(function(event){
                    console.log('clicked')
                    var origin = $origination.val();
                    var dest = $destination.val();
                    var latLngOrigin;
                    var latLngDest;

                    //mymap.removeLayer(latLngOrigin);
                    //mymap.removeLayer(markerOrigin);

                    mymap.removeControl(route);

                    var match = origin.search("85719");
                    if (match == -1) {
                        origin = origin + " 85719";
                    }
                    match = dest.search("85719");
                    if (match == -1) {
                        dest = dest + " 85719";
                    }

                    geocoder = new L.Control.Geocoder.Nominatim();
                    
                    geocoder.geocode(origin, function(originCoords) {
                        latLngOrigin = new L.LatLng(originCoords[0].center.lat, originCoords[0].center.lng);
                        markerOrigin = new L.Marker(latLngOrigin).addTo(mymap);
                        console.log(origin + " was found at " + latLngOrigin.toString());

                        geocoder.geocode(dest, function(destCoords) {    
                            latLngDest = new L.LatLng(destCoords[0].center.lat, destCoords[0].center.lng);
                            markerDest = new L.Marker(latLngDest).addTo(mymap);
                            console.log(dest + " was found at " + latLngDest.toString());
                            
                            var requestData = JSON.stringify({'originLat': latLngOrigin.lat, 'originLng': latLngOrigin.lng, 'destLat': latLngDest.lat, 'destLng': latLngDest.lng});
                            console.log(requestData);

                            $.ajax({
                                url: 'http://72.200.110.63:9190/get_route',
                                type: 'POST',
                                ContentType: 'application/json',
                                data: {'data': requestData}
                            }).done(function(responseData){
                                console.log("Recieved Data from Server ");
                                console.log(responseData);

                                var endpoints = responseData.points;
                                var path = [];

                                for (i = 0; i < endpoints.length; i++) {
                                    path[i] = new L.LatLng(endpoints[i][0], endpoints[i][1], endpoints[i][2]);
                                }

                                route = L.Routing.control({
                                    waypoints: path,
                                    createMarker: function() { return null; },
                                    lineOptions: {
                                        addWaypoints: false
                                    },
                                    waypointMode: 'snap'
                                }).addTo(mymap);
                            }).fail(function(jqXHR, textStatus, errorThrown){
                                console.log(err);
                                alert('Could not reach server (Rory\'s Home)');
                            });
                        });
                    });
                })
    </script>
</html>