<!DOCTYPE html>
<html lang="en">

    <head>
        <title>SafeStroll</title>
        <link rel="shortcut icon" type="image/png" href="./assets/favicon.png" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Predicts safe routes for pedestrians using machine learning and data-driven decision making.">
        <meta name="author" content="Michael Inouye's Gamer Squadron">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin=""/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./css/styles.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
        integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
        crossorigin=""></script>
        <script src="./js/bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <script src="./lib/Leaflet.heat-gh-pages/dist/leaflet-heat.js"></script>
        <script type="text/javascript" src="./assets/uaheatmap.json"></script>

    </head>

    <body>

        <section>

            <div id="mapid"></div>
            <script>
            
                var mymap = L.map('mapid').setView([32.231553, -110.951820], 15);
            
                // Instantiate Leaflet Map
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                    id: 'mapbox.streets'
                }).addTo(mymap);
            
                </script>   
        </section>

        <section id="fields">
            <div class="container">
                <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="origination">Origination</label>
                                <input type="text" class="form-control" id="origination" aria-describedby="" placeholder="Enter current location">
                            </div>
                            <div class="form-group">
                                <label for="destination">Destination</label>
                                <input type="text" class="form-control" id="destination" placeholder="Enter destination">
                            </div>
                            <label for="mode">Route Mode</label>
                            <select id="mode" class="form-control">
                                <option>Daytime Crime</option>
                                <option>Nighttime Crime</option>
                                <option>Bike Accidents</option>
                            </select>
                            <div style="text-align:center;">
                                <button type="submit" id="submit-button" class="btn btn-primary">Map Route</button>
                                <button type="button" id="heat-button" class="btn btn-secondary">Crime Heat Map</button>
                                <i id="loading" class="fa fa-refresh fa-spin"></i>
                            </div>

                        </div>
                    <div class="col-md-6" style="text-align: center">
                        <h1 style="margin-top:20px">StrollSafe</h1>
                        <p>Hack Arizona 2019 Submission, a webapp that predicts safe routes for pedestrians using machine learning and data-driven decision making.</p>
                        <p style="font-size:12px;">Collaboration by Rory Scobie, Michael Bullock, Noah Thurston, and Michael Inouye.</p>
                        <p id="routeFound">Safe route found!</p>
                    </div>
                </div>
            </div>
        </section>
      
        <div class="modal fade" id="serverError" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">Did not receive a response from the server.</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="addressError" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Error</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">Could not resolve address within Tucson city limits.</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>

    </body>
    <script>
        $origination = $("#origination");
        $destination = $("#destination");
        $mode = $('#mode');
        $button = $("#submit-button");
        $heatmapbutton = $("#heat-button");
        $('#errorModal').modal({ show: false});
        var route = L.Routing.control({
                        waypoints: [
                        ]
                    }).addTo(mymap);

        var markerGroup = L.layerGroup().addTo(mymap);
        var heatActive = false;
        var heat;
        var heatmap;

        $heatmapbutton.click(function(event){

            if (heatActive) {
                mymap.removeLayer(heat);
                heatActive = false;
            }

            else {
                heatmap = heatmapdata;

                for (i = 0; i < heatmap.length; i++) {
                    heatmap[i][2] = heatmap[i][2] / 200;
                }

                heat = L.heatLayer(heatmap, {radius: 25}).addTo(mymap);
                heatActive = true;
            }
        });

        $button.click(function(event){
            var origin = $origination.val();
            var dest = $destination.val();
            var mode = document.getElementById( "mode" );
            var latLngOrigin;
            var latLngDest;
            var validRequest = true;

            markerGroup.clearLayers()
            mymap.removeControl(route);
            document.getElementById("loading").style.visibility = "visible";

            var match = origin.search("85719");
            if (match == -1) {
                origin = origin + " 85719";
            }

            match = dest.search("85719");
            if (match == -1) {
                dest = dest + " 85719";
            }

            geocoder = new L.Control.Geocoder.Nominatim();
            
            geocoder.geocode(origin, function(originCoords) {

                if (originCoords[0] == null) {
                    validRequest = false;
                    document.getElementById("routeFound").style.display = "none";
                    $('#addressError').modal('show');
                }
                else {
                    latLngOrigin = new L.LatLng(originCoords[0].center.lat, originCoords[0].center.lng);
                    markerOrigin = new L.Marker(latLngOrigin).addTo(markerGroup);
                    console.log(origin + " was found at " + latLngOrigin.toString());
                }


                geocoder.geocode(dest, function(destCoords) {

                    if (destCoords[0] == null) {
                        validRequest = false;
                        document.getElementById("routeFound").style.display = "none";
                        $('#addressError').modal('show');
                    }
                    else {
                        latLngDest = new L.LatLng(destCoords[0].center.lat, destCoords[0].center.lng);
                        markerDest = new L.Marker(latLngDest).addTo(markerGroup);
                        console.log(dest + " was found at " + latLngDest.toString());
                    }

                    if (validRequest) {
                        var requestData = JSON.stringify({'originLat': latLngOrigin.lat, 'originLng': latLngOrigin.lng, 'destLat': latLngDest.lat, 'destLng': latLngDest.lng, 'dataset': mode.selectedIndex});
                        console.log(requestData);

                        //start

                        var xhr = new XMLHttpRequest();

                        xhr.responseType = "json";
                        xhr.open("POST", "http://72.200.110.63:9190/get_route", true);

                        xhr.addEventListener("load", function() {
                            console.log("Recieved Data from Server ");
                            //console.log(xhr.responseText);
                            document.getElementById("loading").style.visibility = "hidden";
                            var responseData = JSON.parse(xhr.response);
                            var endpoints = responseData.points;
                            var path = [];

                            for (i = 0; i < endpoints.length; i++) {
                                path[i] = new L.LatLng(endpoints[i][0], endpoints[i][1], endpoints[i][2]);
                            }

                            route = L.Routing.control({
                                waypoints: path,
                                //createMarker: function() { return null; },
                                /*lineOptions: {
                                    addWaypoints: false
                                },*/
                                waypointMode: 'snap',
                                lineOptions: {
                                    styles: [{color: 'red', opacity: 0, weight: 5}]
                                }
                                
                            }).addTo(mymap);

                            if (window.innerWidth < 750) {
                                route.hide();
                            }
                            else route.show();

                            document.getElementById("routeFound").style.display = "block";

                        });

                        xhr.addEventListener("progress", function(){
                            document.getElementById("loading").style.visibility = "visible";
                        });

                        /*xhr.addEventListener("error", function(jqXHR, textStatus, errorThrown){
                            document.getElementById("loading").style.visibility = "hidden";
                            console.log(errorThrown);
                            document.getElementById("routeFound").style.display = "none";
                            $('#serverError').modal('show');
                        });*/


                        xhr.setRequestHeader("Content-Type", "application/json");
                        xhr.send(requestData);
                        //end

                        /*$.ajax({
                            url: 'http://72.200.110.63:9190/get_route',
                            type: 'POST',
                            ContentType: 'application/json',

                            data: {'data': requestData}
                        }).done(function(responseData){
                            console.log("Recieved Data from Server ");
                            console.log(responseData);

                            var endpoints = responseData.points;
                            var path = [];

                            for (i = 0; i < endpoints.length; i++) {
                                path[i] = new L.LatLng(endpoints[i][0], endpoints[i][1], endpoints[i][2]);
                            }

                            route = L.Routing.control({
                                waypoints: path,
                                createMarker: function() { return null; },
                                lineOptions: {
                                    addWaypoints: false
                                },
                                waypointMode: 'snap',
                                
                            }).addTo(mymap);

                            if (window.innerWidth < 750) {
                                route.hide();
                            }
                            else route.show();

                            document.getElementById("routeFound").style.display = "block";
                            
                        }).fail(function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            document.getElementById("routeFound").style.display = "none";
                            $('#serverError').modal('show');
                        });*/
                    }
                });
            });
        })
    </script>
</html>